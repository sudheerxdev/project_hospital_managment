version: "3.9"

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-hotel_db}
      POSTGRES_USER: ${POSTGRES_USER:-hotel_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hotel_pass}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hotel_user} -d ${POSTGRES_DB:-hotel_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      DJANGO_DEBUG: "false"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-change-me-in-prod-change-me-in-prod-1234}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1}
      DJANGO_CSRF_TRUSTED_ORIGINS: ${DJANGO_CSRF_TRUSTED_ORIGINS:-http://localhost}
      USE_SQLITE: "false"
      POSTGRES_DB: ${POSTGRES_DB:-hotel_db}
      POSTGRES_USER: ${POSTGRES_USER:-hotel_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hotel_pass}
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
      FIELD_ENCRYPTION_KEY: ${FIELD_ENCRYPTION_KEY:-change-this-key}
      EMAIL_BACKEND: ${EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-noreply@stayflow.local}
      EMAIL_HOST: ${EMAIL_HOST:-}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-true}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
      SMS_WEBHOOK_URL: ${SMS_WEBHOOK_URL:-}
      SMS_WEBHOOK_TOKEN: ${SMS_WEBHOOK_TOKEN:-}
    volumes:
      - backend_logs:/app/logs
    expose:
      - "8000"

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_BASE: /api
    depends_on:
      - backend
    ports:
      - "80:80"

volumes:
  postgres_data:
  backend_logs:
